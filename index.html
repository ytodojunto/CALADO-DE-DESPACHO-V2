<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Náutica Multi-Tramo</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VTGH8J2KN8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-VTGH8J2KN8');
    </script>

    <style>
        body {font-family: Arial, sans-serif; padding: 20px; background-color: #333; color: #fff; transition: background-color .5s;}
        .container {max-width: 480px; margin: auto; padding: 25px; border: 1px solid #555; border-radius: 8px; background:#444;}
        body.scheme-canales {background:#1a364a;}
        .scheme-canales .container {background:#2a4c61;}
        #appLogo {display:block; max-width:100px; margin:0 auto 15px;}
        .tramo-info {background:#555; padding:10px; margin-bottom:15px; border-radius:4px; border-left:5px solid #00bcd4;}
        h2 {text-align:center; border-bottom:2px solid #555; padding-bottom:10px;}
        .tab-button {background:#666; color:#fff; padding:10px 15px; border:none; cursor:pointer; margin-right:5px;}
        .tab-button.active {background:#007bff;}
        input, button {width:100%; padding:10px; margin:10px 0; background:#666; color:#fff; border:1px solid #777;}
        .resultado {font-size:1.4em; font-weight:bold; margin-top:20px; padding-top:10px; border-top:2px solid #777; color:#4caf50;}
        #calculate-cd, #calculate-msbq {background:#008000; font-weight:900; font-size:1.1em;}
    </style>
</head>
<body>

<div class="container">
    <img src="logo (2).png" alt="Logo" id="appLogo">
    <h2>Calculadora Náutica</h2>

    <div class="tramo-selector">
        <label>Tramo / Reglamentación:</label>
        <select id="tramoSelect" onchange="cambiarTramo(this.value)">
            <option value="parana">RÍO PARANÁ Y SUS BRAZOS</option>
            <option value="canales">CANALES (P. Indio, Intermedio, etc.)</option>
        </select>
    </div>
    <div class="tramo-info">
        Aplicando reglas para: <strong id="tramoActualDisplay">RÍO PARANÁ Y SUS BRAZOS</strong>
    </div>

    <div style="text-align:center; margin:20px 0;">
        <button class="tab-button active" id="btn-cd" onclick="mostrar('tab-cd',this)">PE → Calado Máximo</button>
        <button class="tab-button" id="btn-msbq" onclick="mostrar('tab-msbq',this)">Calado → Margen</button>
    </div>

    <!-- Pestaña 1: Profundidad → Calado -->
    <div id="tab-cd" class="tab-content">
        <h3>Calado de Despacho Máximo</h3>
        <label>Profundidad Efectiva (PE) en metros:</label>
        <input type="number" id="peInput" step="0.01" placeholder="Ej: 11.04">
        <button id="calculate-cd" onclick="calcCaladoDesdePE()">Calcular</button>
        <div class="resultado">
            Calado Máximo Permitido: <span id="resultadoCD">---</span> m
        </div>
    </div>

    <!-- Pestaña 2: Calado → Margen -->
    <div id="tab-msbq" class="tab-content" style="display:none;">
        <h3>Margen de Seguridad Requerido</h3>
        <label>Calado Propio (CD) en metros:</label>
        <input type="number" id="caladoInput" step="0.01" placeholder="Ej: 10.38">
        <button id="calculate-msbq" onclick="calcMargenDesdeCD()">Calcular</button>
        <div class="resultado">
            Margen de Seguridad: <span id="resultadoMSBQ">---</span> m
        </div>
    </div>
</div>

<script>
const RULES = {
    parana: {
        name: "RÍO PARANÁ Y SUS BRAZOS",
        class: "scheme-parana",
        cdStart: 10.36,
        cd10porc: 10.50,
        incrementoCm: 3        // 3 cm por cada cm de exceso
    },
    canales: {
        name: "CANALES (P. Indio, Intermedio, etc.)",
        class: "scheme-canales",
        cdStart: 10.36,
        cd10porc: 10.68,
        incrementoCm: 1.5      // 1.5 cm por cada cm de exceso
    }
};

let current = RULES.parana;

// ==== PE → Calado máximo permitido ====
function calcCaladoDesdePE() {
    const pe = parseFloat(document.getElementById('peInput').value);
    if (isNaN(pe) || pe <= 0) return alert("Ingrese PE válida");

    let cd;
    if (pe <= 10.96) {
        cd = pe - 0.60;
    } else if (current === RULES.parana && pe >= 11.55 || current === RULES.canales && pe >= 11.7748) {
        cd = pe / 1.10;
    } else {
        // zona intermedia: fórmula lineal oficial
        if (current === RULES.parana) {
            cd = (pe + 30.48) / 4;
        } else {
            cd = (pe + 14.94) / 2.5;
        }
    }
    cd = Math.max(0, Math.floor(cd * 100) / 100);
    document.getElementById('resultadoCD').textContent = cd.toFixed(2);

    gtag('event', 'calc_pe_a_cd', {tramo: current.name, pe: pe, cd: cd.toFixed(2)});
}

// ==== Calado → Margen de Seguridad (LA QUE FALLABA) ====
function calcMargenDesdeCD() {
    const cd = parseFloat(document.getElementById('caladoInput').value);
    if (isNaN(cd) || cd <= 0) return alert("Ingrese calado válido");

    let margen;

    if (cd <= current.cdStart) {
        margen = 0.60;
    }
    else if (cd >= current.cd10porc) {
        margen = cd * 0.10;
    }
    else {
        // ZONA INTERMEDIA: 3 cm o 1.5 cm por cada cm (o fracción) de exceso → redondeo ARRIBA
        const excesoCm = cd - current.cdStart;           // ej: 10.38 → 0.02 m
        const cmExceso = Math.ceil(excesoCm * 100);      // 2 cm (redondea arriba)
        const incremento = cmExceso * current.incrementoCm; // 2 × 3 = 6  o  2 × 1.5 = 3
        margen = 0.60 + (incremento / 100);
    }

    // Redondeo final siempre hacia arriba en zona intermedia
    margen = (current === RULES.parana && cd > current.cdStart && cd < current.cd10porc) || 
             (current === RULES.canales && cd > current.cdStart && cd < current.cd10porc) ?
             Math.ceil(margen * 100) / 100 : Math.round(margen * 100) / 100;

    document.getElementById('resultadoMSBQ').textContent = margen.toFixed(2);

    gtag('event', 'calc_cd_a_margen', {tramo: current.name, calado: cd, margen: margen.toFixed(2)});
}

// Interfaz
function cambiarTramo(v) {
    current = RULES[v];
    document.getElementById('tramoActualDisplay').textContent = current.name;
    document.body.className = current.class;
    gtag('event', 'cambiar_tramo', {tramo: current.name});
}
function mostrar(id, btn) {
    document.querySelectorAll('.tab-content').forEach(e=>e.style.display='none');
    document.getElementById(id).style.display='block';
    document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
}

// Init
window.onload = () => {
    cambiarTramo('parana');
    mostrar('tab-cd', document.getElementById('btn-cd'));
};
</script>
</body>
</html>
