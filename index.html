<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Náutica Oficial - 100% Exacta</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VTGH8J2KN8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-VTGH8J2KN8');
    </script>
    <style>
        body {font-family: Arial, sans-serif; padding:20px; background:#333; color:#fff; margin:0;}
        .container {max-width:480px; margin:20px auto; padding:25px; background:#444; border:1px solid #555; border-radius:8px;}
        body.canales {background:#1a364a;}
        .canales .container {background:#2a4c61;}
        #appLogo {display:block; max-width:100px; margin:0 auto 20px;}
        h2 {text-align:center; margin-bottom:20px;}
        select, input, button {width:100%; padding:12px; margin:10px 0; border-radius:4px; border:none; font-size:1em;}
        select, input {background:#666; color:#fff;}
        button {background:#008000; color:#fff; font-weight:bold;}
        .tab-button {background:#666; color:#fff; padding:10px 15px; border:none; margin:5px; border-radius:4px;}
        .tab-button.active {background:#007bff;}
        .resultado {font-size:1.8em; font-weight:bold; color:#4caf50; text-align:center; margin:25px 0; padding:15px; background:#333; border-radius:8px;}
        table {width:100%; border-collapse:collapse; margin:15px 0; font-size:0.9em;}
        th, td {border:1px solid #666; padding:6px; text-align:center;}
        th {background:#555;}
    </style>
</head>
<body>
    <div class="container">
        <img src="logo (2).png" alt="Logo" id="appLogo">
        <h2>Calculadora Náutica Oficial</h2>

        <select id="tramoSelect" onchange="cambiarTramo()">
            <option value="parana">RÍO PARANÁ Y SUS BRAZOS</option>
            <option value="canales">CANALES (P. Indio, Intermedio, etc.)</option>
        </select>

        <div style="text-align:center; margin:20px 0;">
            <button class="tab-button active" onclick="mostrar('tab-cd')">PE → Calado</button>
            <button class="tab-button" onclick="mostrar('tab-msbq')">Calado → Margen</button>
            <button class="tab-button" onclick="mostrar('tab-tabla')">Tablas Oficiales</button>
        </div>

        <div id="tab-cd" class="tab-content">
            <label>Profundidad Efectiva (PE):</label>
            <input type="number" step="0.01" id="peInput" placeholder="Ej: 11.04">
            <button onclick="calcDesdePE()">Calcular Calado Máximo</button>
            <div class="resultado" id="resultadoCD">—</div>
        </div>

        <div id="tab-msbq" class="tab-content" style="display:none;">
            <label>Calado Propio (CD):</label>
            <input type="number" step="0.01" id="caladoInput" placeholder="Ej: 10.38">
            <button onclick="calcDesdeCalado()">Calcular Margen</button>
            <div class="resultado" id="resultadoMSBQ">—</div>
        </div>

        <div id="tab-tabla" class="tab-content" style="display:none;">
            <h3 id="tablaTitulo">RÍO PARANÁ</h3>
            <div id="tablaContenido"></div>
        </div>
    </div>

    <script>
        // === TABLAS OFICIALES 100% EXACTAS (las que vos mandaste) ===
        const TABLAS = {
            parana: [
                {cd:10.37,m:0.63,pe:11.00},{cd:10.38,m:0.66,pe:11.04},{cd:10.39,m:0.69,pe:11.08},
                {cd:10.40,m:0.72,pe:11.12},{cd:10.41,m:0.75,pe:11.16},{cd:10.42,m:0.78,pe:11.20},
                {cd:10.43,m:0.81,pe:11.24},{cd:10.44,m:0.84,pe:11.28},{cd:10.45,m:0.87,pe:11.32},
                {cd:10.46,m:0.90,pe:11.36},{cd:10.47,m:0.93,pe:11.40},{cd:10.48,m:0.96,pe:11.44},
                {cd:10.49,m:0.99,pe:11.48}
            ],
            canales: [
                {cd:10.37,m:0.62,pe:10.98},{cd:10.38,m:0.63,pe:11.01},{cd:10.39,m:0.65,pe:11.04},
                {cd:10.40,m:0.66,pe:11.06},{cd:10.41,m:0.68,pe:11.09},{cd:10.42,m:0.69,pe:11.11},
                {cd:10.43,m:0.71,pe:11.13},{cd:10.44,m:0.72,pe:11.16},{cd:10.45,m:0.74,pe:11.18},
                {cd:10.46,m:0.75,pe:11.21},{cd:10.47,m:0.77,pe:11.23},{cd:10.48,m:0.78,pe:11.26},
                {cd:10.49,m:0.80,pe:11.29},{cd:10.50,m:0.81,pe:11.31},{cd:10.51,m:0.83,pe:11.34},
                {cd:10.52,m:0.84,pe:11.36},{cd:10.53,m:0.86,pe:11.38},{cd:10.54,m:0.87,pe:11.41},
                {cd:10.55,m:0.89,pe:11.44},{cd:10.56,m:0.90,pe:11.46},{cd:10.57,m:0.92,pe:11.49},
                {cd:10.58,m:0.93,pe:11.51},{cd:10.59,m:0.95,pe:11.53},{cd:10.60,m:0.96,pe:11.56},
                {cd:10.61,m:0.98,pe:11.58},{cd:10.62,m:0.99,pe:11.61},{cd:10.63,m:1.01,pe:11.63},
                {cd:10.64,m:1.02,pe:11.66},{cd:10.65,m:1.04,pe:11.68},{cd:10.66,m:1.05,pe:11.71},
                {cd:10.67,m:1.07,pe:11.73}
            ]
        };

        let tramo = 'parana';

        // === CÁLCULO EXACTO POR TABLA ===
        function obtenerMargen(cd) {
            cd = parseFloat(cd.toFixed(2));
            const fila = TABLAS[tramo].find(f => f.cd === cd);

            if (fila) return fila.m;
            
            // Regla general para CD <= 10.36
            if (cd <= 10.36) return 0.60;
            
            // Regla de extrapolación: M = CD * 0.10
            if (tramo==='parana' && cd >= 10.50) return parseFloat((cd * 0.10).toFixed(2));
            if (tramo==='canales' && cd >= 10.68) return parseFloat((cd * 0.10).toFixed(2));

            return null; // fuera de rango
        }

        /**
         * FUNCIÓN ACTUALIZADA: Calcula el calado máximo (CD) dada la profundidad efectiva (PE).
         * Incluye la lógica de redondeo solicitada para el tramo Paraná.
         */
        function obtenerCaladoDesdePE(pe) {
            pe = parseFloat(pe.toFixed(2));
            const fila = TABLAS[tramo].find(f => f.pe === pe);

            if (fila) return fila.cd; // Paso 1: Valor exacto en la tabla

            // Lógica para 'parana'
            if (tramo === 'parana') {
                const PE_MAX_EXPLICITO = 11.48;     // PE de CD=10.49
                const PE_MIN_EXTRAPOLACION = 11.55; // PE de CD=10.50 (donde comienza la regla CD/1.10)
                
                // Paso 2: Manejo de interpolación para 11.48 < PE < 11.55
                // Si PE cae en este rango, se despacha con el calado del PE anterior (CD=10.49)
                if (pe > PE_MAX_EXPLICITO && pe < PE_MIN_EXTRAPOLACION) {
                    return 10.49;
                }

                // Paso 3: Manejo de valores bajos (PE <= 10.96)
                if (pe <= 10.96) return parseFloat((pe - 0.60).toFixed(2));
                
                // Paso 4: Manejo de valores altos (PE >= 11.55)
                // CD = PE / 1.10 (porque M=CD*0.10, entonces PE=CD+CD*0.10 = CD*1.10. Luego CD = PE/1.10)
                if (pe >= PE_MIN_EXTRAPOLACION) return parseFloat((pe / 1.10).toFixed(2));
            } 
            
            // Lógica para 'canales' (se mantiene la lógica original)
            if (tramo === 'canales') {
                if (pe <= 10.96) return parseFloat((pe - 0.60).toFixed(2));
                if (pe >= 11.7748) return parseFloat((pe / 1.10).toFixed(2)); // Límite superior original
            }

            return null; // fuera de rango
        }

        // === FUNCIONES PRINCIPALES ===
        function calcDesdeCalado() {
            const cd = parseFloat(document.getElementById('caladoInput').value);
            const margen = obtenerMargen(cd);
            document.getElementById('resultadoMSBQ').textContent = margen !== null ? margen.toFixed(2) + " m" : "Fuera de tabla";
            gtag('event', 'calc_calado_margen', {tramo, calado: cd, margen});
        }

        function calcDesdePE() {
            const pe = parseFloat(document.getElementById('peInput').value);
            const cd = obtenerCaladoDesdePE(pe);
            document.getElementById('resultadoCD').textContent = cd !== null ? cd.toFixed(2) + " m" : "Fuera de tabla";
            gtag('event', 'calc_pe_calado', {tramo, pe, calado: cd});
        }

        // === INTERFAZ ===
        function cambiarTramo() {
            tramo = document.getElementById('tramoSelect').value;
            document.body.className = tramo === 'canales' ? 'canales' : '';
            mostrarTabla();
        }

        function mostrar( pestaña ) {
            document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none');
            document.getElementById(pestaña).style.display = 'block';
            document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
            // Usamos un control para asegurar que el target existe antes de usar classList
            const targetButton = event.target.closest('.tab-button');
            if (targetButton) {
                targetButton.classList.add('active');
            } else {
                // Si no es un click directo en el botón (ej. llamado desde init), podemos seleccionar el primer botón
                document.querySelector(`.tab-button[onclick*="mostrar('${pestaña}')"]`).classList.add('active');
            }
            if (pestaña==='tab-tabla') mostrarTabla();
        }

        function mostrarTabla() {
            document.getElementById('tablaTitulo').textContent = tramo==='parana' ? 'RÍO PARANÁ (10.37-10.49)' : 'CANALES (10.37-10.67)';
            const html = '<table><tr><th>Calado</th><th>Margen</th><th>PE</th></tr>' + TABLAS[tramo].map(f => `<tr><td>${f.cd}</td><td>${f.m}</td><td>${f.pe}</td></tr>`).join('') + '</table>';
            document.getElementById('tablaContenido').innerHTML = html;
        }

        // Init
        cambiarTramo(); 
        mostrar('tab-cd'); // Asegura que la pestaña inicial sea PE -> Calado
    </script>
</body>
</html>
